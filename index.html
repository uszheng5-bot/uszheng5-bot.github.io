<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>æ™ºèƒ½é”æ§åˆ¶å™¨ v2.5.2 (Web BLE)</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00FF88">

<style>
/* CSS Styles (ä¿ç•™åŸç‰ˆæ ·å¼ï¼Œä¸ºæ–°å…ƒç´ æ·»åŠ é€‚åº”) */
:root{
  --bg1:#06070a; --bg2:#0f1116; --card:#0f1214;
  --accent:#00ff88; --accent-2:#38d04b; --muted:#9aa0a6;
  --glass: rgba(255,255,255,0.03);
  --danger:#ff6b6b; --ease:cubic-bezier(.4,0,.2,1);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(160deg,var(--bg1),var(--bg2));font-family:"Segoe UI",Inter,Roboto,Arial;color:#fff;-webkit-font-smoothing:antialiased}
.app{max-width:980px;margin:18px auto;padding:14px;display:grid;grid-template-columns:360px 1fr;gap:18px}
@media(max-width:820px){.app{grid-template-columns:1fr;padding:10px}}

.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 14px 40px rgba(0,0,0,0.6)}
.left{display:flex;flex-direction:column;align-items:center;gap:12px}
.circle{width:260px;height:260px;border-radius:50%;position:relative;display:flex;align-items:center;justify-content:center;background:conic-gradient(var(--accent-2) 0deg,#2a2a30 0deg);transition:background .45s var(--ease),transform .18s var(--ease);box-shadow:0 20px 40px rgba(0,0,0,0.6);cursor:pointer;overflow:visible}
.circle::before{content:"";position:absolute;width:200px;height:200px;border-radius:50%;background:radial-gradient(circle at top,#0b0b0b,#101218);box-shadow:inset 0 6px 14px rgba(0,0,0,0.6)}
.circle-inner{position:absolute;width:170px;text-align:center;z-index:2}
.circle-title{font-size:20px;font-weight:700}
.circle-sub{font-size:13px;color:var(--muted);margin-top:6px}

/* highlight animations */
.circle.flash-success{animation:flashSuccess 1.6s both}
@keyframes flashSuccess{0%{transform:scale(1)}25%{transform:scale(1.03);box-shadow:0 0 26px rgba(124,243,124,0.35)}60%{transform:scale(1.02);box-shadow:0 0 18px rgba(124,243,124,0.25)}100%{transform:scale(1)}}
.circle.flash-fail{animation:flashFail 1.6s both}
@keyframes flashFail{0%{transform:scale(1)}25%{transform:scale(1.03);box-shadow:0 0 26px rgba(255,107,107,0.35)}60%{transform:scale(1.02);box-shadow:0 0 18px rgba(255,107,107,0.25)}100%{transform:scale(1)}}

/* controls */
.controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.btn{border:0;padding:10px 14px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#28b64a);color:#002;font-weight:800;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,0.45)}
.btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06)}
.btn.small{padding:8px 10px;font-size:13px}
.btn:disabled {opacity: 0.5; cursor: not-allowed;} /* ç¦ç”¨æ ·å¼ */


/* right */
.right{display:flex;flex-direction:column;gap:10px}
.hdr-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
h1{margin:0;color:var(--accent);font-size:18px}
.meta{color:var(--muted);font-size:13px}
.stats{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.stat{background:var(--glass);padding:8px;border-radius:10px;min-width:110px}
.stat .label{font-size:12px;color:var(--muted)}
.stat .val{font-weight:700;margin-top:6px}
#log{margin-top:8px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.25);max-height:420px;overflow:auto;font-size:13px;color:#dfeff0;white-space:pre-wrap}

/* modal */
.modal-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);backdrop-filter: blur(6px);z-index:80}
.modal{width:92%;max-width:520px;background:linear-gradient(180deg,#0f1115,#0b0c10);border-radius:12px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,0.7);transform:scale(.96);opacity:0;transition:transform .28s var(--ease),opacity .28s var(--ease)}
.modal.show{transform:scale(1);opacity:1}
.modal h3{margin:0;color:var(--accent);font-size:18px}
.modal p.lead{color:var(--muted);margin:8px 0 12px 0;font-size:13px}

/* custom +/- selector */
.selector{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px}
.sel-block{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:8px;border-radius:10px;min-width:90px;text-align:center;border:1px solid rgba(255,255,255,0.03)}
.sel-num{font-size:20px;font-weight:800}
.icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);border-radius:8px;padding:6px 10px;color:var(--muted);cursor:pointer}
.icon-btn:active{transform:translateY(1px)}

/* calendar */
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
.cal-day{height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700}
.cal-day.disabled{color:rgba(255,255,255,0.12)}
.cal-day.today{border:1px solid rgba(124,243,124,0.12)}
.cal-day.selected{background:linear-gradient(180deg,var(--accent),#28b64a);color:#001}

/* foot */
.foot{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:8px}
.primary{background:linear-gradient(180deg,var(--accent),#28b64a);padding:8px 12px;border-radius:8px;color:#001;font-weight:800}

/* toast */
.toast{position:fixed;left:50%;top:14%;transform:translateX(-50%);background:rgba(0,0,0,0.9);padding:12px 18px;border-radius:10px;z-index:200;display:none;transition:all .3s var(--ease)}
.toast.show{display:block;animation:pop .3s var(--ease)}
@keyframes pop{from{transform:translate(-50%,-10px);opacity:0}to{transform:translate(-50%,0);opacity:1}}
.toast.error{background:rgba(255,107,107,0.85); color:#ffe; font-weight: 700;} /* æ–°å¢é”™è¯¯é£æ ¼ */
.toast .muted{color:inherit; opacity: 0.8;}

.muted{color:var(--muted);font-size:13px}

/* clear storage small */
.clear-storage{background:transparent;border:1px dashed rgba(255,255,255,0.06);color:var(--muted);padding:6px 8px;border-radius:8px;font-size:13px;cursor:pointer}
</style>
</head>
<body>
  <div class="app">
    <div class="card left">
      <div id="lockCircle" class="circle" title="ç‚¹å‡»ä¸Šé”/æŸ¥çœ‹ï¼ˆéšè—æ¨¡å¼ï¼‰">
        <div class="circle-inner">
          <div id="circleTitle" class="circle-title">æœªä¸Šé”</div>
          <div id="circleSub" class="circle-sub">ç‚¹å‡»ä¸Šé”</div>
        </div>
      </div>

      <div class="controls">
        <button id="connectBtn" class="btn small">è¿æ¥è®¾å¤‡</button>
        <button id="timerBtn" class="btn small">è®¾ç½®å®šæ—¶</button>
        <button id="lotteryBtn" class="btn small">ğŸ æŠ½å¥–</button>
        <button id="batteryBtn" class="btn small ghost">ğŸ”‹ æŸ¥ç”µé‡</button>
      </div>

      <div class="controls" style="margin-top: 6px;">
        <button id="midUnlockBtn" class="btn small" style="display:none; background:#ff8c42">ğŸ”“ ä¸­é€”è§£é”</button>
      </div>

      <div style="display:flex;gap:8px;justify-content:center;margin-top:6px">
        <button id="guessBtn" class="ghost small" style="display:none">ğŸ•¹ï¸ çŒœå‰©ä½™æ—¶é—´</button>
      </div>

      <div style="text-align:center;margin-top:8px">
        <div class="muted">ç›®æ ‡ç»“æŸï¼š<span id="targetTime">-</span></div>
        <div class="muted">å‰©ä½™ï¼š<strong id="remainingText">-</strong></div>
      </div>
    </div>

    <div class="card right">
      <div class="hdr-row">
        <div>
          <h1>æ™ºèƒ½é” Â· v2.5.2 Web BLE</h1>
          <div class="meta" style="color:#f99">ğŸš¨ éœ€ HTTPS/localhost, å…¼å®¹ Chrome/Edge</div>
        </div>
        <div>
        </div>
      </div>

      <div class="stats" style="margin-top:12px">
        <div class="stat"><div class="label">è¿æ¥</div><div id="connStatus" class="val">æœªè¿æ¥</div></div>
        <div class="stat"><div class="label">é”å®š</div><div id="lockStatusDisplay" class="val">æœªä¸Šé”</div></div>
        <div class="stat"><div class="label">ç”µé‡</div><div id="countShort" class="val">â€”</div></div>
      </div>

      <div id="log">æ—¥å¿—åŒºï¼ˆWeb BLE äº¤äº’ï¼‰\n</div>
    </div>
  </div>
    
  <div id="timerModal" class="modal-overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>è®¾ç½®å®šæ—¶</h3>
      <p class="lead">é€‰æ‹©å€’è®¡æ—¶/æ—¥æœŸ/éšæœºã€‚å€’è®¡æ—¶ä½¿ç”¨åŠ /å‡æŒ‰é’®ï¼ˆæ›´é€‚åˆè§¦æ§ï¼‰ã€‚</p>
  
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <div style="flex:1">
          <div class="label">æ¨¡å¼</div>
          <div style="display:flex;gap:8px">
              <button id="modeCountdown" class="fake-mode primary" style="flex:1">å€’è®¡æ—¶</button>
              <button id="modeDate" class="fake-mode ghost" style="flex:1">æŒ‡å®šæ—¥æœŸ</button>
              <button id="modeRandom" class="fake-mode ghost" style="flex:1">éšæœº</button>
          </div>
          </div>
      </div>
  
      <div id="countdownBlock">
          <div class="selector">
          <div class="sel-block">
              <div class="muted">å¤©</div>
              <div class="sel-num" id="daysVal">0</div>
              <div style="display:flex;gap:6px;margin-top:8px;justify-content:center">
              <button class="icon-btn" id="daysMinus">-</button>
              <button class="icon-btn" id="daysPlus">+</button>
              </div>
          </div>
          <div class="sel-block">
              <div class="muted">å°æ—¶</div>
              <div class="sel-num" id="hoursVal">0</div>
              <div style="display:flex;gap:6px;margin-top:8px;justify-content:center">
              <button class="icon-btn" id="hoursMinus">-</button>
              <button class="icon-btn" id="hoursPlus">+</button>
              </div>
          </div>
          <div class="sel-block">
              <div class="muted">åˆ†é’Ÿ</div>
              <div class="sel-num" id="minsVal">5</div>
              <div style="display:flex;gap:6px;margin-top:8px;justify-content:center">
              <button class="icon-btn" id="minsMinus">-</button>
              <button class="icon-btn" id="minsPlus">+</button>
              </div>
          </div>
          </div>
      </div>
  
      <div id="dateBlock" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
          <button id="prevMon" class="ghost">â—€</button>
          <div id="monthLabel" class="muted">2025 å¹´ 11 æœˆ</div>
          <button id="nextMon" class="ghost">â–¶</button>
          </div>
          <div class="calendar" id="calendarGrid"></div>
          <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
          <div class="sel-block" style="width:120px">
              <div class="muted">å°æ—¶</div>
              <div class="sel-num" id="dateHour">12</div>
              <div style="display:flex;gap:6px;margin-top:8px;justify-content:center">
              <button class="icon-btn" id="dateHourMinus">-</button>
              <button class="icon-btn" id="dateHourPlus">+</button>
              </div>
          </div>
          <div class="sel-block" style="width:120px">
              <div class="muted">åˆ†é’Ÿ</div>
              <div class="sel-num" id="dateMin">0</div>
              <div style="display:flex;gap:6px;margin-top:8px;justify-content:center">
              <button class="icon-btn" id="dateMinMinus">-</button>
              <button class="icon-btn" id="dateMinPlus">+</button>
              </div>
          </div>
          </div>
      </div>
  
      <div id="randomBlock" style="display:none;margin-top:10px">
          <label style="display:flex;align-items:center;gap:8px">
          <input id="randomHide" type="checkbox" /> <span class="muted">éšè—å‰©ä½™æ—¶é—´ï¼ˆå…è®¸æŸ¥çœ‹/çŒœæµ‹ï¼‰</span>
          </label>
      </div>

      <div style="margin-top:12px;padding-top:12px;border-top:1px dashed rgba(255,255,255,0.06)">
          <div class="label" style="margin-bottom:6px">å®šæ—¶æœŸé—´ä¸­é€”è§£é”æƒé™è®¾ç½® (éæ‰‹åŠ¨æ¨¡å¼)</div>
          <div style="display:flex;gap:12px;align-items:flex-start">
              
              <div class="sel-block" style="min-width:70px;flex:1">
                  <div class="muted">æ€»æ¬¡æ•°</div>
                  <div class="sel-num" id="unlockCountVal">0</div>
                  <div style="display:flex;gap:6px;margin-top:8px;justify-content:center">
                      <button class="icon-btn" id="unlockCountMinus">-</button>
                      <button class="icon-btn" id="unlockCountPlus">+</button>
                  </div>
              </div>
              
              <div class="sel-block" style="min-width:70px;flex:1">
                  <div class="muted">é—´éš” (å¤©)</div>
                  <div class="sel-num" id="intervalDaysVal">0</div>
                  <div style="display:flex;gap:6px;margin-top:8px;justify-content:center">
                      <button class="icon-btn" id="intervalDaysMinus">-</button>
                      <button class="icon-btn" id="intervalDaysPlus">+</button>
                  </div>
              </div>
              
          </div>
          <div style="font-size:13px;color:var(--muted);padding:8px 0 0 0">
              <div style="margin-top:4px">è®¾å®š **0** æ¬¡æˆ– **0** é—´éš”è¡¨ç¤º**ä¸å…è®¸**ä¸­é€”è§£é”ã€‚</div>
              <div style="margin-top:4px">è§£é”åéœ€**æ‰‹åŠ¨ç‚¹å‡»åœ†ç¯é‡é”**ï¼Œå®šæ—¶ç»§ç»­ã€‚</div>
          </div>
      </div>
      <div class="foot">
          <button id="cancelTimer" class="ghost">å–æ¶ˆ</button>
          <button id="confirmTimer" class="primary">ç¡®å®š</button>
      </div>
    </div>
  </div>
  
    <div id="lotteryModal" class="modal-overlay">
        <div class="modal">
        <h3>æŠ½å¥–ï¼ˆ10% ~ 60%ï¼‰</h3>
        <p class="lead">ä»…åœ¨å®šæ—¶é”å®šï¼ˆéæ‰‹åŠ¨ï¼‰å¯ç”¨</p>
        <div class="lottery-anim" style="height:72px;border-radius:10px;background:#0f0f10;display:flex;align-items:center;justify-content:center;margin:12px 0"><span style="opacity:.2">æ­£åœ¨æŠ½å¥–â€¦</span></div>
        <div id="lotteryResult" style="display:none;text-align:center">
            <div id="lotteryMain" style="font-size:18px"></div>
            <div id="lotteryDetail" class="muted" style="margin-top:6px"></div>
        </div>
        <div class="foot">
            <button id="closeLottery" class="ghost">å…³é—­</button>
            <button id="doLottery" class="primary">å¼€å§‹æŠ½å¥–</button>
        </div>
        </div>
    </div>
  
    <div id="viewModal" class="modal-overlay">
        <div class="modal">
        <h3>æŸ¥çœ‹å‰©ä½™æ—¶é—´</h3>
        <p class="lead">æŸ¥çœ‹ä¼šå¥–åŠ±å°‘é‡å»¶é•¿ï¼ˆä»…ä¸€æ¬¡ï¼‰ â€” æŸ¥çœ‹åå‰©ä½™å°†**å†æ¬¡éšè—**</p>
        <div class="lottery-anim" style="height:72px;border-radius:10px;background:#0f0f10;display:flex;align-items:center;justify-content:center;margin:12px 0"><span style="opacity:.2">å‡†å¤‡æŸ¥çœ‹â€¦</span></div>
        <div id="viewResult" style="display:none;text-align:center">
            <div id="viewMain" style="font-size:18px"></div>
            <div id="viewDetail" class="muted" style="margin-top:6px"></div>
        </div>
        <div class="foot">
            <button id="closeView" class="ghost">å…³é—­</button>
            <button id="doView" class="primary" style="background:#6ec6ff;color:#000">æŸ¥çœ‹å¹¶è·å¾—å¥–åŠ±</button>
        </div>
        </div>
    </div>
  
    <div id="guessModal" class="modal-overlay">
        <div class="modal">
        <h3>çŒœå‰©ä½™æ™‚é–“</h3>
        <p class="muted">è¯¯å·® &lt;10% ç®—æˆåŠŸï¼ˆçŒœéŒ¯åˆ™å¢åŠ æ—¶é—´ï¼‰</p>
        <div style="display:flex;gap:8px;justify-content:center;margin-top:10px">
            <div class="sel-block"><div class="muted">å¤©</div><div class="sel-num" id="gDays">0</div><div style="display:flex;gap:6px;margin-top:8px"><button class="icon-btn" id="gDaysMinus">-</button><button class="icon-btn" id="gDaysPlus">+</button></div></div>
            <div class="sel-block"><div class="muted">æ—¶</div><div class="sel-num" id="gHours">0</div><div style="display:flex;gap:6px;margin-top:8px"><button class="icon-btn" id="gHoursMinus">-</button><button class="icon-btn" id="gHoursPlus">+</button></div></div>
            <div class="sel-block"><div class="muted">åˆ†</div><div class="sel-num" id="gMins">0</div><div style="display:flex;gap:6px;margin-top:8px"><button class="icon-btn" id="gMinsMinus">-</button><button class="icon-btn" id="gMinsPlus">+</button></div></div>
        </div>
        <div class="foot">
            <button id="closeGuess" class="ghost">å–æ¶ˆ</button>
            <button id="doGuess" class="primary" style="background:#ffd54f;color:#000">æäº¤çŒœæµ‹</button>
        </div>
        </div>
    </div>
  
    <div id="guessToast" class="toast"></div>


<script>
/* ---------- constants & state ---------- */
const MAX_SECONDS = 90 * 24 * 3600;
const MIN_SECONDS = 60;
let connected=false, total=0, remaining=0, timerId=null, targetEnd=null;
let hideMode=false, viewUsed=false, batteryLevel=85;

// **V2.5 æ ¸å¿ƒçŠ¶æ€**
let lockStatus = 'unlocked'; // 'locked_manual', 'locked_timer', 'unlocked_temp' (å®šæ—¶æœŸé—´ä¸´æ—¶è§£é”)
let maxUnlockCount = 0;       // å®šæ—¶æœŸé—´æœ€å¤§å¼€é”æ¬¡æ•°
let usedUnlockCount = 0;      // å·²ç”¨å¼€é”æ¬¡æ•°
let intervalDays = 0;         // å®šæ—¶æœŸé—´å…è®¸è§£é”çš„é—´éš”å¤©æ•° (0=ä¸é™åˆ¶)
let lastUnlockTime = 0;       // ä¸Šæ¬¡æˆåŠŸä¸­é€”è§£é”çš„æ—¶é—´æˆ³ (ç”¨äºè®¡ç®—é—´éš”å¤©æ•°)

/* BLE UUIDs (Inferred from user's data) */
const SERVICE_UUID = '00008ac0-0000-1000-8000-00805f9b34fb';
const WRITE_CHAR_UUID = '00008ac1-0000-1000-8000-00805f9b34fb';
const DEVICE_NAME_PREFIX = ['AA-A100']; // Match AA-A100X devices

/* DOM helper */
const $ = id => document.getElementById(id);
const midUnlockBtn = $('midUnlockBtn'); 

/* logging */
function log(msg){
  const area = $('log'); const ts = new Date().toLocaleTimeString();
  area.textContent += `[${ts}] ${msg}\n`; area.scrollTop = area.scrollHeight; console.log(msg);
}
function logError(msg){ log(`âŒ é”™è¯¯: ${msg}`); }

/* format */
function fmt(sec){ if(!sec||sec<=0) return '0ç§’'; const d=Math.floor(sec/86400), h=Math.floor((sec%86400)/3600), m=Math.floor((sec%3600)/60), s=sec%60; return `${d?d+'å¤© ':''}${h?h+'å°æ—¶ ':''}${m?m+'åˆ† ':''}${s}ç§’`; }

/**
 * V2.5 ç»Ÿä¸€å‘½ä»¤ï¼šæ„å»º 4 å­—èŠ‚å¼€å…³é” BLE å‘½ä»¤ (DataView)
 * ç”¨äºæ‰‹åŠ¨å¼€å…³é”ã€å®šæ—¶é”å¯åŠ¨/ç»“æŸã€ä¸­é€”è§£é”/é‡é”ã€‚
 * @param {boolean} lock - true: å…³é” (AA 01 00 00), false: å¼€é” (AA 01 01 00)
 * @returns {DataView} 4 å­—èŠ‚çš„ DataView
 */
function buildCommand(lock) {
    // å‘½ä»¤æ ¼å¼: AA 01 [Status] 00
    // lock=true -> Status=00 (å…³é”/ä¸Šé”)
    // lock=false -> Status=01 (å¼€é”/è§£é”)
    const status = lock ? 0x00 : 0x01;
    const arr = [0xAA, 0x01, status, 0x00];
    const dataView = new DataView(new Uint8Array(arr).buffer);
    const hexStr = arr.map(b => b.toString(16).padStart(2, '0')).join(' ').toUpperCase();
    return { dataView, hexStr };
}

/* ---------- Web Bluetooth Manager ---------- */
const BleManager = {
    device: null,
    writeCharacteristic: null,

    async connect() {
        if (!navigator.bluetooth) {
            logError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Web Bluetooth APIï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edge (HTTPS/localhost)');
            return false;
        }

        try {
            log('ğŸ” æ­£åœ¨æœç´¢è®¾å¤‡ (åç§° AA-A100*)...');
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'AA-A100' }],
                optionalServices: ['generic_access', SERVICE_UUID] 
            });
            this.device = device;
            this.device.addEventListener('gattserverdisconnected', this.onDisconnected);

            log(`ğŸ”— å°è¯•è¿æ¥: ${device.name}`);
            const server = await device.gatt.connect();

            log(`ğŸ› ï¸ è·å–æœåŠ¡: ${SERVICE_UUID}`);
            const service = await server.getPrimaryService(SERVICE_UUID);

            log(`âœï¸ è·å–å†™å…¥ç‰¹å¾å€¼: ${WRITE_CHAR_UUID}`);
            this.writeCharacteristic = await service.getCharacteristic(WRITE_CHAR_UUID);
            
            connected = true;
            log(`âœ… è¿æ¥æˆåŠŸï¼è®¾å¤‡: ${device.name}`);
            updateUI();
            return true;

        } catch (error) {
            logError(`è¿æ¥å¤±è´¥: ${error.message}`);
            connected = false;
            this.device = null;
            this.writeCharacteristic = null;
            updateUI();
            return false;
        }
    },

    onDisconnected(event) {
        log(`ğŸ”´ è®¾å¤‡å·²æ–­å¼€: ${event.target.name}`);
        connected = false;
        BleManager.device = null;
        BleManager.writeCharacteristic = null;
        updateUI();
    },

    async disconnect() {
        if (this.device && this.device.gatt.connected) {
            this.device.gatt.disconnect();
            log('ğŸ‘‹ å·²æ–­å¼€è¿æ¥');
            connected = false;
            updateUI();
        }
    },

    /**
     * å‘é€æ•°æ®åˆ°å†™å…¥ç‰¹å¾å€¼
     */
    async sendData(dataView, commandName) {
        if (!connected || !this.writeCharacteristic) {
            logError(`ğŸš« æ— æ³•å‘é€ ${commandName}: è®¾å¤‡æœªè¿æ¥æˆ–ç‰¹å¾å€¼ä¸å¯ç”¨ã€‚`);
            return false;
        }
        try {
            await this.writeCharacteristic.writeValue(dataView.buffer);
            log(`ğŸ“¤ [${commandName}] å‘é€æˆåŠŸ: ${Array.from(new Uint8Array(dataView.buffer)).map(b=>b.toString(16).padStart(2,'0')).join(' ').toUpperCase()}`);
            return true;
        } catch (error) {
            logError(`å†™å…¥å¤±è´¥ [${commandName}]: ${error.message}`);
            return false;
        }
    }
};

/* ---------- localStorage persistence ---------- */
const STORAGE_KEY = 'smartlock_v2_5_state';
function saveState(){
    try{
        const state = { 
            lockStatus, total, remaining, targetEnd, hideMode, viewUsed, batteryLevel,
            maxUnlockCount, usedUnlockCount, intervalDays, lastUnlockTime 
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }catch(e){ console.warn('saveState err',e); }
}

function clearSavedState(){
    localStorage.removeItem(STORAGE_KEY);
}

function loadState(){
    try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return false;
        const s = JSON.parse(raw);
        
        // æ¢å¤ V2.5 çŠ¶æ€
        lockStatus = s.lockStatus || 'unlocked'; 
        total = s.total || 0; 
        hideMode = !!s.hideMode; 
        viewUsed = !!s.viewUsed; 
        batteryLevel = s.batteryLevel || 85;

        maxUnlockCount = s.maxUnlockCount || 0;
        usedUnlockCount = s.usedUnlockCount || 0;
        intervalDays = s.intervalDays || 0;
        lastUnlockTime = s.lastUnlockTime || 0;
        
        // æ¢å¤è®¡æ—¶å™¨
        if (s.targetEnd){
            targetEnd = s.targetEnd; 
            const rem = Math.floor((targetEnd - Date.now())/1000);
            remaining = Math.max(0, rem);

            if ((lockStatus.startsWith('locked') || lockStatus === 'unlocked_temp') && remaining > 0){
                startCountdown(remaining, { hide: hideMode, resume:true });
            } else if (remaining <= 0){
                // å®šæ—¶ç»“æŸï¼Œæ¸…ç†çŠ¶æ€
                lockStatus = 'unlocked'; total=0; remaining=0; targetEnd=null; usedUnlockCount=0; lastUnlockTime=0;
                log('âš ï¸ æ¢å¤çŠ¶æ€æ—¶å‘ç°å€’è®¡æ—¶å·²è¿‡æœŸï¼Œå·²é‡ç½®ä¸ºæœªä¸Šé”');
            }
        }
        return true;
    }catch(e){ console.warn('loadState err', e); return false; }
}

/**
 * é€šç”¨çš„ Toast æç¤ºå‡½æ•° (æ›¿ä»£ alert)
 * @param {string} mainMsg - ä¸»è¦ä¿¡æ¯
 * @param {string} detailMsg - è¯¦ç»†ä¿¡æ¯ (å¯é€‰)
 * @param {boolean} isError - æ˜¯å¦æ˜¯é”™è¯¯/é˜»æ­¢æç¤º
 */
function showToast(mainMsg, detailMsg, isError = false) { 
    const t=$('guessToast'); 
    t.innerHTML = `<div style="font-size:16px">${mainMsg}</div>${detailMsg ? `<div class="muted" style="margin-top:2px">${detailMsg}</div>` : ''}`;
    t.classList.remove('show', 'error');
    if (isError) {
        t.classList.add('error');
    }
    t.classList.add('show'); 
    t.style.display='block'; 
    setTimeout(()=>{ t.classList.remove('show'); t.style.display='none'; },2800); 
}

/**
 * V2.4/V2.5 æ ¸å¿ƒï¼šæ‰§è¡Œä¸­é€”è§£é”çš„ç‹¬ç«‹å‡½æ•°
 */
function executeMidUnlock() {
    lockStatus = 'unlocked_temp'; // çŠ¶æ€å˜ä¸ºä¸´æ—¶è§£é”
    usedUnlockCount++;          // ä½¿ç”¨æ¬¡æ•°+1
    lastUnlockTime = Date.now(); // æ›´æ–°ä¸Šæ¬¡è§£é”æ—¶é—´

    // å‘é€è§£é”å‘½ä»¤ (4 å­—èŠ‚)
    const { dataView } = buildCommand(false); // false = è§£é”
    BleManager.sendData(dataView, 'å®šæ—¶æœŸé—´å…è®¸è§£é” (4 å­—èŠ‚)');
    
    // V2.5.2 ä¿®æ­£ï¼šä¸´æ—¶è§£é”æˆåŠŸæ—¶ï¼Œéšè—æ¨¡å¼ä¸‹ä¸æ³„éœ²å‰©ä½™æ¬¡æ•°
    const toastDetail = hideMode ? 'é‡é”åå®šæ—¶ç»§ç»­' : `å‰©ä½™ ${maxUnlockCount - usedUnlockCount} æ¬¡`;
    showToast('âœ… ä¸´æ—¶è§£é”æˆåŠŸ', toastDetail, false);

    log(`ğŸ”“ å®šæ—¶æœŸé—´å…è®¸è§£é”ï¼šå‰©ä½™ ${maxUnlockCount - usedUnlockCount} æ¬¡ã€‚`);
    
    updateUI(); // UI æ›´æ–°æ˜¾ç¤ºä¸´æ—¶è§£é”çŠ¶æ€
}

/**
 * V2.5.2 æ ¸å¿ƒï¼šæ ¹æ® hideMode å’Œ lockStatus è·å–å‰©ä½™æ—¶é—´çš„æ˜¾ç¤ºæ–‡æœ¬
 */
function getRemainingDisplayText() {
    // å¤„äºå®šæ—¶é”å®šçŠ¶æ€
    if (lockStatus === 'locked_timer' || lockStatus === 'unlocked_temp') {
        // åªè¦å®šæ—¶ä»»åŠ¡åœ¨è¿è¡Œï¼Œä¸” hideMode ä¸º trueï¼Œé‚£ä¹ˆæ— è®º locked_timer è¿˜æ˜¯ unlocked_temp éƒ½éšè—æ—¶é—´
        if (hideMode) {
            // åªæœ‰ä¸»åŠ¨ç‚¹å‡»â€œæŸ¥çœ‹â€æŒ‰é’®åï¼ŒviewModal ä¸­æ‰ä¼šçŸ­æš‚æ˜¾ç¤ºçœŸå®æ—¶é—´
            return 'å·²éšè— (çŒœ/çœ‹)'; 
        }
        return fmt(remaining); // ééšè—æ¨¡å¼ï¼Œæ˜¾ç¤ºç²¾ç¡®æ—¶é—´
    }
    // éå®šæ—¶é”å®šçŠ¶æ€
    return '-';
}


/* UI update */
function updateUI(){
    const connState = connected ? 'å·²è¿æ¥' : (BleManager.device ? 'æ–­å¼€' : 'æœªè¿æ¥');
    $('connStatus').textContent = connState;
    $('connectBtn').textContent = connected ? 'æ–­å¼€è¿æ¥' : 'è¿æ¥è®¾å¤‡';
    
    // **æ ¸å¿ƒé”å®šçŠ¶æ€æ˜¾ç¤º**
    let lockStatusText = 'æœªä¸Šé”';
    let isTimerMode = lockStatus === 'locked_timer';
    let isTempUnlocked = lockStatus === 'unlocked_temp';
    const hasUnlockPermission = maxUnlockCount > 0; 

    if (lockStatus === 'locked_manual') {
        lockStatusText = 'æ‰‹åŠ¨ä¸Šé”';
    } else if (isTimerMode || isTempUnlocked) {
        const unlockLeft = maxUnlockCount - usedUnlockCount;
        lockStatusText = isTempUnlocked ? 'ä¸´æ—¶è§£é”' : (hideMode ? 'å®šæ—¶ï¼ˆéšè—ï¼‰' : 'å®šæ—¶é”å®š');
        if (maxUnlockCount > 0 && !hideMode) { // V2.5.2 ä¿®æ­£ï¼šéšè—æ¨¡å¼ä¸‹ä¸æ˜¾ç¤ºæ¬¡æ•°
            lockStatusText += ` (${Math.max(0, unlockLeft)}/${maxUnlockCount} æ¬¡)`;
        }
    }
    $('lockStatusDisplay').textContent = lockStatusText;

    // ç”µé‡æ˜¾ç¤º
    $('countShort').textContent = `${batteryLevel}%`;
    
    // V2.5.2 ä¿®æ­£ 1ï¼šå¤„ç†ç›®æ ‡ç»“æŸæ—¶é—´
    let targetTimeDisplay = targetEnd ? new Date(targetEnd).toLocaleString() : '-';
    if ((lockStatus === 'locked_timer' || lockStatus === 'unlocked_temp') && hideMode) {
        targetTimeDisplay = 'å·²éšè—';
    }
    $('targetTime').textContent = targetTimeDisplay;
    
    // **V2.5 å‰©ä½™æ—¶é—´/åœ†ç¯/çŠ¶æ€é€»è¾‘**
    let remainingDisplay = getRemainingDisplayText();
    
    const circle = $('lockCircle'), title = $('circleTitle'), sub = $('circleSub');

    // åœ†ç¯æ ·å¼
    circle.classList.remove('locked_timer', 'locked_manual', 'flash-success', 'flash-fail'); 

    if (isTimerMode || isTempUnlocked) {
        const ratio = total>0 ? Math.max(0,Math.min(1,remaining/total)) : 0;
        const deg = ratio*360;
        circle.style.background = `conic-gradient(var(--accent-2) ${deg}deg,#2a2a30 0deg)`;
        circle.classList.add('locked_timer');

        // V2.5.2 ä¿®æ­£ 2ï¼šå¦‚æœä¸´æ—¶è§£é”æ˜¯åŸºäºéšè—æ¨¡å¼å¼€å¯çš„ï¼Œæ ‡é¢˜ä¹Ÿåº”æ›´å…·æ¬ºéª—æ€§
        title.textContent = isTempUnlocked ? 
            (hideMode ? 'ğŸ”“ ä¸´æ—¶è§£é”ä¸­ï¼ˆè®¡æ—¶éšè—ï¼‰' : 'ğŸ”“ ä¸´æ—¶è§£é”ä¸­') : 
            (hideMode ? 'ğŸ”’ å®šæ—¶ä¸­ï¼ˆéšè—ï¼‰' : 'ğŸ”’ å®šæ—¶ä¸­');

        const unlockLeft = maxUnlockCount - usedUnlockCount;
        
        let subText;
        if (hideMode) {
             // V2.5.1/2 ä¿®æ­£ï¼šéšè—æ¨¡å¼ä¸‹ Sub Text å¿…é¡»æ˜¯æç¤ºæ–‡æœ¬ (æ— è®ºé”å®šè¿˜æ˜¯ä¸´æ—¶è§£é”)
             subText = isTempUnlocked ? 'è®¡æ—¶éšè—ä¸­ï¼Œç‚¹å‡»åœ†ç¯å¯é‡é”' : (viewUsed ? 'å·²æŸ¥çœ‹ï¼ˆæŸ¥çœ‹åŠŸèƒ½å·²ç”¨ï¼‰' : 'ç‚¹å‡»åœ†ç¯å¯æŸ¥çœ‹ (1 æ¬¡)');
             circle.title = isTempUnlocked ? 'ç‚¹å‡»é‡é”' : 'ç‚¹å‡»æŸ¥çœ‹å‰©ä½™æ—¶é—´'; 
        } else {
             // ééšè—æ¨¡å¼ 
             subText = remainingDisplay;
             if (maxUnlockCount > 0) {
                 const dayStr = intervalDays > 0 ? ` (â‰¥${intervalDays}å¤©)` : '';
                 subText += (subText !== '-') ? ` - å‰© ${Math.max(0, unlockLeft)} æ¬¡${dayStr}` : `å‰©ä½™ ${Math.max(0, unlockLeft)} æ¬¡${dayStr}`;
             }

             // ééšè—æ¨¡å¼ï¼Œåœ†ç¯ç‚¹å‡»æ‰¿æ‹…è§£é”æˆ–é‡é”åŠŸèƒ½
             circle.title = isTempUnlocked ? 'ç‚¹å‡»é‡é”' : 
                            (hasUnlockPermission ? `ç‚¹å‡»ä¸­é€”è§£é” (å‰© ${Math.max(0, unlockLeft)} æ¬¡)` : 'å®šæ—¶é”å®šä¸­');
        }
        sub.textContent = subText;

    } else if (lockStatus === 'locked_manual') {
        circle.style.background = 'conic-gradient(var(--accent) 360deg,#2a2a30 0deg)';
        title.textContent = 'ğŸ”’ æ‰‹åŠ¨é”å®š';
        sub.textContent = 'ç‚¹å‡»è§£é”';
        circle.classList.add('locked_manual');
        circle.title = 'ç‚¹å‡»è§£é”';
    } else { // unlocked
        circle.style.background = 'conic-gradient(var(--accent-2) 0deg,#2a2a30 0deg)';
        title.textContent = connected ? 'ğŸŸ¢ å·²è¿æ¥' : 'æœªä¸Šé”';
        sub.textContent = 'ç‚¹å‡»ä¸Šé”';
        circle.title = 'ç‚¹å‡»ä¸Šé”';
    }

    $('remainingText').textContent = remainingDisplay;
    $('guessBtn').style.display = (isTimerMode && hideMode) ? 'inline-block' : 'none';

    // V2.4/V2.5 æ ¸å¿ƒï¼šæ§åˆ¶ä¸­é€”è§£é”æŒ‰é’®çš„æ˜¾ç¤º
    if ((isTimerMode || isTempUnlocked) && hasUnlockPermission) {
        midUnlockBtn.style.display = 'inline-block';
        
        const unlockLeft = maxUnlockCount - usedUnlockCount;
        const daysPassed = (Date.now() - lastUnlockTime) / (1000 * 3600 * 24);
        const intervalOk = intervalDays === 0 || lastUnlockTime === 0 || daysPassed >= intervalDays;
        
        if (unlockLeft <= 0 || !intervalOk) {
            midUnlockBtn.disabled = true;
            midUnlockBtn.textContent = `è§£é”æ¬¡æ•°/é—´éš”ä¸è¶³`;
            midUnlockBtn.style.background = '#444';
        } else {
            midUnlockBtn.disabled = false;
            // V2.5.2 ä¿®æ­£ï¼šéšè—æ¨¡å¼ä¸‹ä¸æ˜¾ç¤ºæ¬¡æ•°
            midUnlockBtn.textContent = hideMode ? `ğŸ”“ ä¸­é€”è§£é”` : `ğŸ”“ ä¸­é€”è§£é” (${Math.max(0, unlockLeft)}/${maxUnlockCount})`;
            midUnlockBtn.style.background = '#ff8c42';
        }
        
    } else {
        midUnlockBtn.style.display = 'none';
    }

    saveState();
}

/* ---------- click handlers (CORE LOGIC MODIFICATION) ---------- */
$('connectBtn').addEventListener('click', ()=>{ 
    if (connected) { BleManager.disconnect(); } else { BleManager.connect(); }
});

// V2.4/V2.5: æ–°å¢ä¸­é€”è§£é”ä¸“ç”¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
midUnlockBtn.addEventListener('click', () => {
    if (lockStatus !== 'locked_timer' && lockStatus !== 'unlocked_temp') return; 

    if (lockStatus === 'unlocked_temp') {
        showToast('âš ï¸ å·²æ˜¯ä¸´æ—¶è§£é”çŠ¶æ€', 'è¯·ç‚¹å‡»åœ†ç¯é‡é”åå†è¿›è¡Œæ­¤æ“ä½œ', true);
        return;
    }

    const unlockLeft = maxUnlockCount - usedUnlockCount;
    const daysPassed = (Date.now() - lastUnlockTime) / (1000 * 3600 * 24);
    const intervalOk = intervalDays === 0 || lastUnlockTime === 0 || daysPassed >= intervalDays;

    if (!connected) {
        showToast('è®¾å¤‡æœªè¿æ¥', 'è¯·å…ˆè¿æ¥è®¾å¤‡æ‰èƒ½è§£é”', true);
        return;
    }

    if (unlockLeft > 0 && intervalOk) {
        // å…è®¸ä¸­é€”è§£é”
        executeMidUnlock();
    } else {
        // é˜»æ­¢æ“ä½œæç¤º
        if (unlockLeft <= 0) {
            showToast('â›” è§£é”å¤±è´¥', 'å·²è¾¾åˆ°è®¾ç½®çš„æœ€å¤§å¼€é”æ¬¡æ•°', true);
            log('â›” å®šæ—¶é”å®šä¸­ï¼Œä¸èƒ½è§£é” (å·²è¾¾æœ€å¤§å¼€é”æ¬¡æ•°)');
        } else if (!intervalOk) {
            const daysToWait = Math.ceil(intervalDays - daysPassed);
            showToast('â›” è§£é”å¤±è´¥', `éœ€ç­‰å¾… ${daysToWait} å¤©åæ‰èƒ½å†æ¬¡è§£é”`, true);
            log(`â›” å®šæ—¶é”å®šä¸­ï¼Œä¸èƒ½è§£é” (éœ€ç­‰å¾… ${daysToWait} å¤©å)`);
        }
    }
});

$('lockCircle').addEventListener('click', ()=>{
    if (!connected) { logError('ğŸš« è¯·å…ˆè¿æ¥è®¾å¤‡'); showToast('è®¾å¤‡æœªè¿æ¥', 'è¯·ç‚¹å‡» "è¿æ¥è®¾å¤‡" æŒ‰é’®', true); return; }

    // 1. **å®šæ—¶æ¨¡å¼ä¸‹ï¼šéšè—æ—¶é—´æ¨¡å¼** (V2.5.1: åœ†ç¯ç‚¹å‡»åªå¤„ç†æŸ¥çœ‹)
    if (lockStatus === 'locked_timer' && hideMode) {
        if (viewUsed) {
            log('âš ï¸ æŸ¥çœ‹åŠŸèƒ½å·²ä½¿ç”¨è¿‡ä¸€æ¬¡ï¼Œé˜»æ­¢å†æ¬¡ä½¿ç”¨ã€‚'); 
            showToast('âš ï¸ æŸ¥çœ‹åŠŸèƒ½å·²ç”¨', 'ä»…èƒ½ä½¿ç”¨ä¸€æ¬¡', true);
            return;
        }
        showModal('viewModal'); $('viewResult').style.display='none';
        return;
    }
    
    // 2. **å®šæ—¶æ¨¡å¼ä¸‹ï¼šä¸­é€”è§£é”** (ééšè—æ¨¡å¼ä¸‹ï¼Œåœ†ç¯ä»æ‰¿æ‹…è§£é”åŠŸèƒ½)
    if (lockStatus === 'locked_timer' && !hideMode){
        const unlockLeft = maxUnlockCount - usedUnlockCount;
        const daysPassed = (Date.now() - lastUnlockTime) / (1000 * 3600 * 24);
        const intervalOk = intervalDays === 0 || lastUnlockTime === 0 || daysPassed >= intervalDays;
        
        if (unlockLeft > 0 && intervalOk) {
            // å…è®¸ä¸­é€”è§£é”
            executeMidUnlock();
            return;
        } 
        
        // é˜»æ­¢æ“ä½œæç¤º
        if (unlockLeft <= 0) {
            showToast('â›” è§£é”å¤±è´¥', 'å·²è¾¾åˆ°è®¾ç½®çš„æœ€å¤§å¼€é”æ¬¡æ•°', true);
            log('â›” å®šæ—¶é”å®šä¸­ï¼Œä¸èƒ½è§£é” (å·²è¾¾æœ€å¤§å¼€é”æ¬¡æ•°)');
        } else if (!intervalOk) {
            const daysToWait = Math.ceil(intervalDays - daysPassed);
            showToast('â›” è§£é”å¤±è´¥', `éœ€ç­‰å¾… ${daysToWait} å¤©åæ‰èƒ½å†æ¬¡è§£é”`, true);
            log(`â›” å®šæ—¶é”å®šä¸­ï¼Œä¸èƒ½è§£é” (éœ€ç­‰å¾… ${daysToWait} å¤©å)`);
        }
        return;
    }

    // 3. **å®šæ—¶æ¨¡å¼ä¸‹ï¼šä¸Šé”** (lockStatus: unlocked_temp -> locked_timer)
    if (lockStatus === 'unlocked_temp'){
        // æ‰‹åŠ¨é‡é”ï¼Œå®šæ—¶ç»§ç»­è¿è¡Œ
        lockStatus = 'locked_timer'; 
        
        // å‘é€ä¸Šé”å‘½ä»¤ (4 å­—èŠ‚)
        const { dataView } = buildCommand(true); // true = ä¸Šé”
        BleManager.sendData(dataView, 'æ‰‹åŠ¨æ¢å¤å®šæ—¶é”å®š (4 å­—èŠ‚)');
        showToast('ğŸ”’ æ¢å¤é”å®š', 'å®šæ—¶ç»§ç»­è¿è¡Œ', false);
        log('ğŸ”’ æ‰‹åŠ¨æ¢å¤é”å®šï¼Œå®šæ—¶ç»§ç»­');
        updateUI();
        return;
    }


    // 4. **æ‰‹åŠ¨æ¨¡å¼/æ™®é€šæ¨¡å¼åˆ‡æ¢** (lockStatus: unlocked <-> locked_manual)
    if (lockStatus === 'locked_manual' || lockStatus === 'unlocked') {
        const isManualLock = lockStatus === 'unlocked'; // å†³å®šä¸‹ä¸€æ­¥æ˜¯ä¸Šé”è¿˜æ˜¯è§£é”
        
        lockStatus = isManualLock ? 'locked_manual' : 'unlocked';
        
        // å¦‚æœæ‰‹åŠ¨ä¸Šé”ï¼Œæ¸…ç†ä»»ä½•å®šæ—¶çŠ¶æ€
        if (isManualLock && timerId){
            clearInterval(timerId); timerId=null; targetEnd=null; total=0; remaining=0;
            usedUnlockCount = 0; maxUnlockCount = 0; intervalDays = 0; lastUnlockTime = 0;
            hideMode = false; viewUsed = false;
        }
        
        // å‘é€ 4 å­—èŠ‚å¼€å…³å‘½ä»¤
        const { dataView } = buildCommand(isManualLock);
        BleManager.sendData(dataView, isManualLock ? 'æ‰‹åŠ¨ä¸Šé” (4 å­—èŠ‚)' : 'æ‰‹åŠ¨è§£é” (4 å­—èŠ‚)');
        showToast(isManualLock ? 'ğŸ”’ æ‰‹åŠ¨é”å®š' : 'ğŸ”“ å·²è§£é”', isManualLock ? 'å®šæ—¶çŠ¶æ€å·²æ¸…é™¤' : 'è®¾å¤‡å·²è§£é”', false);
        updateUI();
        return;
    }
});

$('batteryBtn').addEventListener('click', ()=>{
    if (!connected) { logError('ğŸš« è¯·å…ˆè¿æ¥è®¾å¤‡'); showToast('è®¾å¤‡æœªè¿æ¥', 'è¯·ç‚¹å‡» "è¿æ¥è®¾å¤‡" æŒ‰é’®', true); return; }
    
    // V2.5: æŸ¥ç”µé‡å‘½ä»¤æ˜¯æœªçŸ¥çš„ï¼Œæˆ‘ä»¬åªèƒ½å‘é€ä¸€ä¸ªç©ºçš„ 4 å­—èŠ‚å‘½ä»¤ AA 00 00 00 æ¥æ¨¡æ‹Ÿè§¦å‘ä¸ŠæŠ¥
    const arr = [0xAA, 0x00, 0x00, 0x00]; // å‡è®¾çš„æŸ¥è¯¢/è§¦å‘å‘½ä»¤
    const dataView = new DataView(new Uint8Array(arr).buffer);
    BleManager.sendData(dataView, 'æŸ¥è¯¢ç”µé‡ (æœªçŸ¥ 4 å­—èŠ‚/æ¨¡æ‹Ÿ)');
    
    // æ¨¡æ‹Ÿæ¥æ”¶
    setTimeout(() => {
        batteryLevel = Math.max(10, batteryLevel - Math.floor(Math.random() * 5));
        log(`ğŸ“¥ [æ¨¡æ‹Ÿæ¥æ”¶] è®¾å¤‡è¿”å›ç”µé‡ï¼š${batteryLevel}%`);
        showToast('ğŸ”‹ ç”µé‡æŸ¥è¯¢æˆåŠŸ', `å½“å‰ç”µé‡ï¼š${batteryLevel}%`, false);
        updateUI();
    }, 800);
});

/* ---------- timer start/stop ---------- */
function clampSeconds(s){ return Math.max(MIN_SECONDS, Math.min(MAX_SECONDS, s)); }
function startCountdown(seconds, options={hide:false,resume:false}){
    if (!connected && !options.resume) { logError('ğŸš« è¯·å…ˆè¿æ¥è®¾å¤‡æ‰èƒ½è®¾ç½®å®šæ—¶'); return; }
    let sec = clampSeconds(seconds);
    if (seconds !== sec) log(`âš ï¸ æ—¶é—´è¶…å‡ºé™åˆ¶ï¼Œå·²è°ƒæ•´ä¸º ${fmt(sec)}`);
    if (timerId && !options.resume){ clearInterval(timerId); timerId=null; }
    
    total = sec;
    remaining = sec;
    lockStatus = 'locked_timer'; // çŠ¶æ€è®¾ä¸ºå®šæ—¶é”å®š
    hideMode = !!options.hide;
    viewUsed = false;

    if (!options.resume){
        usedUnlockCount = 0; 
        lastUnlockTime = 0; 
    }
    
    if (!options.resume){ targetEnd = Date.now() + remaining*1000; }
    if (!targetEnd) targetEnd = Date.now() + remaining*1000;

    // V2.5: ç»Ÿä¸€ä½¿ç”¨ 4 å­—èŠ‚ä¸Šé”å‘½ä»¤
    if (!options.resume){
        const { dataView } = buildCommand(true); // true = ä¸Šé”
        BleManager.sendData(dataView, `å®šæ—¶é”å¯åŠ¨ (4 å­—èŠ‚)`);
        
        // V2.5.1 ä¿®æ­£ï¼šéšè—æ¨¡å¼ä¸æ˜¾ç¤ºç²¾ç¡®æ—¶é—´
        const toastDetail = hideMode ? 'å‰©ä½™æ—¶é—´å·²éšè—ï¼Œè¯·ä½¿ç”¨ "çŒœ" æˆ– "çœ‹"' : `æ—¶é•¿: ${fmt(sec)}`;
        showToast('ğŸ”’ å®šæ—¶é”å®šæˆåŠŸ', toastDetail, false);
    } else {
        log(`ğŸ”„ æ¢å¤å®šæ—¶ï¼ˆä¸å‘é€å‘½ä»¤ï¼‰`);
    }
    updateUI();

    timerId = setInterval(()=>{
        remaining = Math.max(0, Math.floor((targetEnd - Date.now())/1000));
        if (remaining<=0){
            clearInterval(timerId); timerId=null; remaining=0; 
            
            lockStatus = 'unlocked'; 
            usedUnlockCount = 0; maxUnlockCount = 0; intervalDays = 0; lastUnlockTime = 0;
            targetEnd=null; total=0; hideMode=false; viewUsed=false;

            // V2.5: ç»Ÿä¸€ä½¿ç”¨ 4 å­—èŠ‚è§£é”å‘½ä»¤
            const { dataView } = buildCommand(false); // false = è§£é”
            BleManager.sendData(dataView, 'è‡ªåŠ¨è§£é” (4 å­—èŠ‚)');
            showToast('ğŸ”“ å€’è®¡æ—¶ç»“æŸ', 'è®¾å¤‡å·²è‡ªåŠ¨è§£é”', false);
            log('â° å€’è®¡æ—¶ç»“æŸï¼Œè‡ªåŠ¨è§£é”');
            updateUI();
            return;
        }
        updateUI();
    },1000);
}

/* ---------- timer modal UI and logic (UNCHANGED from V2.4) ---------- */
function showModal(id){ const el=$(id); el.style.display='flex'; const m=el.querySelector('.modal'); setTimeout(()=>m.classList.add('show'),10); }
function hideModal(id){ const el=$(id); const m=el.querySelector('.modal'); m.classList.remove('show'); setTimeout(()=>el.style.display='none',240); }

let selectedMode = 'countdown';
$('modeCountdown').addEventListener('click', ()=>{ selectedMode='countdown'; toggleModeUI(); });
$('modeDate').addEventListener('click', ()=>{ selectedMode='date'; toggleModeUI(); });
$('modeRandom').addEventListener('click', ()=>{ selectedMode='random'; toggleModeUI(); });
function toggleModeUI(){
    $('modeCountdown').classList.toggle('primary', selectedMode==='countdown'); $('modeCountdown').classList.toggle('ghost', selectedMode!=='countdown');
    $('modeDate').classList.toggle('primary', selectedMode==='date'); $('modeDate').classList.toggle('ghost', selectedMode!=='date');
    $('modeRandom').classList.toggle('primary', selectedMode==='random'); $('modeRandom').classList.toggle('ghost', selectedMode!=='random');
    $('countdownBlock').style.display = selectedMode==='countdown' ? 'block' : 'none';
    $('dateBlock').style.display = selectedMode==='date' ? 'block' : 'none';
    $('randomBlock').style.display = selectedMode==='random' ? 'block' : 'none';
}

let days=0, hours=0, mins=5;
let unlockCount = 0; 
let intervalDaysLocal = 0; 

function renderSelectors(){
    $('daysVal').textContent = days; $('hoursVal').textContent = hours; $('minsVal').textContent = mins;
    $('unlockCountVal').textContent = unlockCount; 
    $('intervalDaysVal').textContent = intervalDaysLocal;
}

function clampSelectors(){
    if (days<0) days=0; if (days>90) days=90;
    if (hours<0) hours=0; if (hours>23) hours=23;
    if (mins<0) mins=0; if (mins>59) mins=59;

    if (unlockCount<0) unlockCount=0; if (unlockCount>99) unlockCount=99;
    if (intervalDaysLocal<0) intervalDaysLocal=0; if (intervalDaysLocal>30) intervalDaysLocal=30; 

    renderSelectors();
}

['daysPlus','daysMinus','hoursPlus','hoursMinus','minsPlus','minsMinus',
 'unlockCountPlus', 'unlockCountMinus',
 'intervalDaysPlus', 'intervalDaysMinus' 
].forEach(id=>{
    const el=$(id);
    if(!el) return;
    el.addEventListener('click', ()=>{
        if (id==='daysPlus') days++; if (id==='daysMinus') days--;
        if (id==='hoursPlus') hours++; if (id==='hoursMinus') hours--;
        if (id==='minsPlus') mins += 5; if (id==='minsMinus') mins -= 5;
        
        if (id==='unlockCountPlus') unlockCount++;
        if (id==='unlockCountMinus') unlockCount--;
        
        if (id==='intervalDaysPlus') intervalDaysLocal++; 
        if (id==='intervalDaysMinus') intervalDaysLocal--; 

        clampSelectors();
    });
});

let calYear = new Date().getFullYear(), calMonth = new Date().getMonth(); window._calendarSelectedDate = null;
function renderCalendar(){
  const grid = $('calendarGrid'); grid.innerHTML=''; const y=calYear, m=calMonth;
  const first = new Date(y,m,1); const startDow = first.getDay(); const daysInMonth = new Date(y,m+1,0).getDate();
  for(let i=0;i<startDow;i++){ const el=document.createElement('div'); el.className='cal-day disabled'; grid.appendChild(el); }
  for(let d=1; d<=daysInMonth; d++){
    const el=document.createElement('div'); el.className='cal-day'; el.textContent=d;
    const cellDate = new Date(y,m,d);
    const now = new Date();
    if (now.getFullYear()===y && now.getMonth()===m && now.getDate()===d) el.classList.add('today');
    if (window._calendarSelectedDate && window._calendarSelectedDate.getFullYear()===y && window._calendarSelectedDate.getMonth()===m && window._calendarSelectedDate.getDate()===d) el.classList.add('selected');
    el.addEventListener('click', ()=>{ window._calendarSelectedDate = new Date(y,m,d, window._calendarSelectedDate?window._calendarSelectedDate.getHours():12, window._calendarSelectedDate?window._calendarSelectedDate.getMinutes():0,0); renderCalendar(); });
    grid.appendChild(el);
  }
  $('monthLabel').textContent = `${y} å¹´ ${m+1} æœˆ`;
}
$('prevMon').addEventListener('click', ()=>{ calMonth--; if(calMonth<0){calMonth=11;calYear--} renderCalendar(); });
$('nextMon').addEventListener('click', ()=>{ calMonth++; if(calMonth>11){calMonth=0;calYear++} renderCalendar(); });

let dateHour = 12, dateMin = 0; function renderDateHM(){ $('dateHour').textContent=dateHour; $('dateMin').textContent=dateMin; }
['dateHourPlus','dateHourMinus','dateMinPlus','dateMinMinus'].forEach(id=>{
  $(id).addEventListener('click', ()=>{ if(id==='dateHourPlus') dateHour=(dateHour+1)%24; if(id==='dateHourMinus') dateHour=(dateHour+23)%24; if(id==='dateMinPlus') dateMin=(dateMin+5)%60; if(id==='dateMinMinus') dateMin=(dateMin+55)%60; renderDateHM(); });
});

$('timerBtn').addEventListener('click', ()=>{
    if (!connected) { logError('ğŸš« è¯·å…ˆè¿æ¥è®¾å¤‡æ‰èƒ½è®¾ç½®å®šæ—¶'); showToast('è®¾å¤‡æœªè¿æ¥', 'è¯·ç‚¹å‡» "è¿æ¥è®¾å¤‡" æŒ‰é’®', true); return; }
    if (lockStatus.startsWith('locked_timer') || lockStatus === 'unlocked_temp'){
        showToast('âš ï¸ æ— æ³•è®¾ç½®å®šæ—¶', 'å½“å‰å·²æœ‰è¿›è¡Œä¸­çš„å®šæ—¶ä»»åŠ¡', true);
        log('âš ï¸ é˜»æ­¢è®¾ç½®æ–°çš„å®šæ—¶ï¼ˆå·²æœ‰å®šæ—¶ï¼‰');
        return;
    }

    showModal('timerModal');
    selectedMode='countdown';
    toggleModeUI();
    
    days=0; hours=0; mins=5;
    unlockCount = maxUnlockCount; 
    intervalDaysLocal = intervalDays; 

    clampSelectors();
    calYear = new Date().getFullYear(); calMonth = new Date().getMonth(); window._calendarSelectedDate = null; renderCalendar(); renderDateHM();
    $('randomHide').checked=false;
});

$('cancelTimer').addEventListener('click', ()=> hideModal('timerModal'));
$('confirmTimer').addEventListener('click', ()=>{
    if (lockStatus.startsWith('locked_timer') || lockStatus === 'unlocked_temp'){ showToast('âš ï¸ æ— æ³•è®¾ç½®å®šæ—¶', 'å½“å‰å·²æœ‰è¿›è¡Œä¸­çš„å®šæ—¶ä»»åŠ¡', true); hideModal('timerModal'); return; }
    let sec = 0;
    if (selectedMode==='countdown'){ sec = days*86400 + hours*3600 + mins*60; }
    else if (selectedMode==='date'){ if(!window._calendarSelectedDate){ showToast('è¯·é€‰æ‹©æ—¥æœŸ', '', true); return; } const dt = new Date(window._calendarSelectedDate); dt.setHours(dateHour, dateMin,0,0); sec = Math.floor((dt.getTime()-Date.now())/1000); if (sec>MAX_SECONDS){ log('âš ï¸ é€‰æ‹©æ—¥æœŸè¶…è¿‡ 90 å¤©ä¸Šé™ï¼Œè‡ªåŠ¨è°ƒæ•´'); sec = MAX_SECONDS; } }
    else { sec = Math.floor(Math.random()*(MAX_SECONDS-MIN_SECONDS+1))+MIN_SECONDS; }
    if (sec<=0){ showToast('è¯·é€‰æ‹©å°†æ¥æ—¶é—´', '(>0 ç§’)', true); return; }
    const hideChecked = $('randomHide').checked;

    maxUnlockCount = unlockCount; 
    intervalDays = intervalDaysLocal; 

    hideModal('timerModal');
    startCountdown(sec, { hide: selectedMode==='random' && hideChecked });
});

/* ---------- lottery, view, guess logic (V2.5.1/2 UPDATED for hiding time) ---------- */
$('lotteryBtn').addEventListener('click', ()=>{ 
    if (!connected) { logError('ğŸš« è¯·å…ˆè¿æ¥è®¾å¤‡'); showToast('è®¾å¤‡æœªè¿æ¥', 'è¯·ç‚¹å‡» "è¿æ¥è®¾å¤‡" æŒ‰é’®', true); return; } 
    if (lockStatus !== 'locked_timer'){ log('âš ï¸ æŠ½å¥–ä»…åœ¨å®šæ—¶é”å®šçŠ¶æ€ä¸‹å¯ç”¨'); showToast('âš ï¸ æ— æ³•æŠ½å¥–', 'æŠ½å¥–ä»…åœ¨å®šæ—¶é”å®šçŠ¶æ€ä¸‹å¯ç”¨', true); return; }
    showModal('lotteryModal'); $('lotteryResult').style.display='none'; 
});
$('closeLottery').addEventListener('click', ()=> hideModal('lotteryModal'));
$('doLottery').addEventListener('click', ()=>{
    if (lockStatus !== 'locked_timer'){ log('âš ï¸ æŠ½å¥–ä»…åœ¨å®šæ—¶é”å®šçŠ¶æ€ä¸‹å¯ç”¨'); $('doLottery').disabled=false; return; }
    $('doLottery').disabled=true;
    setTimeout(()=>{ 
      const percent=Math.floor(Math.random()*51)+10; const add=Math.random()<0.5; const delta=Math.floor(remaining*(percent/100)); const prev=remaining;
      
      const newRemainingText = hideMode ? 'æ—¶é—´å·²æ›´æ–°' : `æ–°å‰©ä½™ ${fmt(remaining)}`; // V2.5.1 ä¿®æ­£ A1
      
      if (add){ 
        remaining = Math.min(remaining+delta, MAX_SECONDS); 
        $('lotteryMain').innerHTML=`<span style="color:#c7ffb3;font-weight:700">+${percent}%</span>`; 
        $('lotteryDetail').textContent=`å»¶é•¿ ${fmt(delta)}ï¼Œ${newRemainingText}`; // V2.5.1 ä¿®æ­£ A2
      } else { 
        remaining = Math.max(remaining-delta, MIN_SECONDS); 
        $('lotteryMain').innerHTML=`<span style="color:#ffb3a8;font-weight:700">-${percent}%</span>`; 
        $('lotteryDetail').textContent=`å‡å°‘ ${fmt(delta)}ï¼Œ${newRemainingText}`; // V2.5.1 ä¿®æ­£ A3
      }
      
      $('lotteryResult').style.display='block'; targetEnd = Date.now()+remaining*1000; 
      
      // V2.5: ç»Ÿä¸€ä½¿ç”¨ 4 å­—èŠ‚ä¸Šé”å‘½ä»¤ (æ›´æ–°è®¡æ—¶ï¼Œé‡æ–°å‘é€é”å®šä¿¡å·)
      const {dataView} = buildCommand(true); 
      BleManager.sendData(dataView, `æŠ½å¥–æ›´æ–°å®šæ—¶ (4 å­—èŠ‚)`);
      
      // V2.5.1 ä¿®æ­£ A4ï¼šæ—¥å¿—ä¹Ÿè¦æ¨¡ç³ŠåŒ–
      const logRemaining = hideMode ? 'æ—¶é—´å·²å˜åŒ–' : fmt(remaining); 
      log(`ğŸ æŠ½å¥–ç»“æœï¼š${add?'å¢åŠ ':'å‡å°‘'} ${percent}%ï¼ˆ${fmt(delta)}ï¼‰ï¼Œæ–°å‰©ä½™ ${logRemaining}`); 
      
      updateUI(); $('doLottery').disabled=false; 
    },1400);
});

$('closeView').addEventListener('click', ()=> { hideModal('viewModal'); $('viewResult').style.display='none'; saveState(); });

$('doView').addEventListener('click', ()=>{
    if (lockStatus !== 'locked_timer' || !connected) { logError('ğŸš« æŸ¥çœ‹ä»…åœ¨å®šæ—¶é”å®šä¸­å¯ç”¨'); hideModal('viewModal'); return; }
    if (viewUsed) { log('âš ï¸ æŸ¥çœ‹åŠŸèƒ½å·²ä½¿ç”¨è¿‡ä¸€æ¬¡ï¼Œé˜»æ­¢å†æ¬¡ä½¿ç”¨ã€‚'); hideModal('viewModal'); return; }
    
    $('doView').disabled=true;

    setTimeout(()=>{ 
      const pct=Math.floor(Math.random()*3)+1; 
      const delta=Math.floor(remaining*(pct/100)); 
      remaining = Math.min(remaining+delta, MAX_SECONDS);
      
      viewUsed=true; 
      targetEnd = Date.now()+remaining*1000;
      
      $('viewResult').style.display='block';
      // V2.5.1 ä¿®æ­£ B1ï¼šæŸ¥çœ‹æ¨¡å¼ä¸‹ï¼Œè¿™é‡Œæ˜¯å”¯ä¸€å…è®¸æ˜¾ç¤ºç²¾ç¡®æ—¶é—´çš„åœ°æ–¹
      $('viewMain').textContent=`çœŸå®å‰©ä½™ï¼š${fmt(remaining)}`; 
      $('viewDetail').textContent=`æŸ¥çœ‹å¥–åŠ±ï¼šå»¶é•¿ ${pct}%ï¼ˆ+${fmt(delta)}ï¼‰ï¼Œä¸‹æ¬¡ä¸èƒ½å†æŸ¥çœ‹`;
      
      // V2.5: ç»Ÿä¸€ä½¿ç”¨ 4 å­—èŠ‚ä¸Šé”å‘½ä»¤ (æ›´æ–°è®¡æ—¶ï¼Œé‡æ–°å‘é€é”å®šä¿¡å·)
      const {dataView} = buildCommand(true);
      BleManager.sendData(dataView, `æŸ¥çœ‹å¥–åŠ±æ›´æ–°å®šæ—¶ (4 å­—èŠ‚)`);
      
      // V2.5.1 ä¿®æ­£ B2ï¼šæ—¥å¿—ä¹Ÿè¦æ˜ç¡®æ˜¯æŸ¥çœ‹æ¨¡å¼ä¸‹çš„æ˜¾ç¤º
      log(`ğŸ‘ï¸ æŸ¥çœ‹ï¼ˆéšè—ï¼‰å¥–åŠ± +${pct}%ï¼ˆ+${fmt(delta)}ï¼‰ï¼Œæ–°å‰©ä½™ ${fmt(remaining)}`);
      
      const c=$('lockCircle'); 
      c.classList.add('flash-success'); 
      setTimeout(()=>c.classList.remove('flash-success'),1600);
      
      updateUI(); 
      
      $('doView').disabled=true;
      $('doView').textContent = 'å·²ä½¿ç”¨';
      $('doView').style.background = '#333';
      $('doView').style.color = '#9aa0a6';
    },900);
});

let gDays=0,gHours=0,gMins=0;
function renderGuess(){ $('gDays').textContent=gDays; $('gHours').textContent=gHours; $('gMins').textContent=gMins; }
['gDaysPlus','gDaysMinus','gHoursPlus','gHoursMinus','gMinsPlus','gMinsMinus'].forEach(id=>{
  const el=$(id); if(!el) return; el.addEventListener('click', ()=>{ if(id==='gDaysPlus') gDays++; if(id==='gDaysMinus') gDays--; if(id==='gHoursPlus') gHours++; if(id==='gHoursMinus') gHours--; if(id==='gMinsPlus') gMins+=5; if(id==='gMinsMinus') gMins-=5; if(gDays<0)gDays=0; if(gDays>90)gDays=90; if(gHours<0)gHours=0; if(gHours>23)gHours=23; if(gMins<0)gMins=0; if(gMins>59)gMins=59; renderGuess(); });
});
$('guessBtn').addEventListener('click', ()=>{ 
    if(!connected) { logError('ğŸš« è¯·å…ˆè¿æ¥è®¾å¤‡'); showToast('è®¾å¤‡æœªè¿æ¥', 'è¯·ç‚¹å‡» "è¿æ¥è®¾å¤‡" æŒ‰é’®', true); return; } 
    if(lockStatus !== 'locked_timer' || !hideMode){ log('âš ï¸ çŒœæ—¶é—´ä»…åœ¨éšæœºéšè—å®šæ—¶ä¸‹å¯ç”¨'); showToast('âš ï¸ çŒœæ—¶é—´ä¸å¯ç”¨', 'ä»…åœ¨éšæœºéšè—å®šæ—¶æ¨¡å¼ä¸‹å¯ç”¨', true); return; } 
    showModal('guessModal'); renderGuess(); 
});
$('closeGuess').addEventListener('click', ()=> hideModal('guessModal'));
$('doGuess').addEventListener('click', ()=>{ 
  const guessed = gDays*86400 + gHours*3600 + gMins*60; 
  if(guessed<=0){ showToast('è¯·è¾“å…¥æœ‰æ•ˆçŒœæµ‹', '', true); return; } 
  
  const actual=remaining; const diff=Math.abs(guessed-actual); const err=diff/actual; 
  const success = err<0.10; const pct=Math.floor(Math.random()*6)+5; const delta=Math.floor(actual*(pct/100)); 
  hideModal('guessModal'); 
  
  if(success){ 
    remaining = Math.max(actual-delta, MIN_SECONDS); 
    // V2.5.1 ä¿®æ­£ C1ï¼šToast æç¤ºä¸­ä¸èƒ½å‡ºç°æ–°çš„å‰©ä½™æ—¶é—´
    showToast(`âœ… çŒœå¯¹ï¼å‡å°‘ ${pct}%`, `èŠ‚çœ ${fmt(delta)}ï¼Œæ—¶é—´å·²æ›´æ–°`, false); 
    // V2.5.1 ä¿®æ­£ C1ï¼šLog ä¸­ä¹Ÿä¸èƒ½å‡ºç°æ–°çš„å‰©ä½™æ—¶é—´
    log(`ğŸ•¹ï¸ çŒœæµ‹æˆåŠŸï¼ˆè¯¯å·® ${(err*100).toFixed(1)}%ï¼‰ï¼Œå‡å°‘ ${pct}%ï¼ˆ-${fmt(delta)}ï¼‰ï¼Œæ—¶é—´å·²å˜åŒ–`); 
  } else { 
    remaining = Math.min(actual+delta, MAX_SECONDS); 
    // V2.5.1 ä¿®æ­£ C1ï¼šToast æç¤ºä¸­ä¸èƒ½å‡ºç°æ–°çš„å‰©ä½™æ—¶é—´
    showToast(`âŒ çŒœé”™ï¼å¢åŠ  ${pct}%`, `æƒ©ç½š ${fmt(delta)}ï¼Œæ—¶é—´å·²æ›´æ–°`, true); 
    // V2.5.1 ä¿®æ­£ C1ï¼šLog ä¸­ä¹Ÿä¸èƒ½å‡ºç°æ–°çš„å‰©ä½™æ—¶é—´
    log(`ğŸ•¹ï¸ çŒœæµ‹å¤±è´¥ï¼ˆè¯¯å·® ${(err*100).toFixed(1)}%ï¼‰ï¼Œå¢åŠ  ${pct}%ï¼ˆ+${fmt(delta)}ï¼‰ï¼Œæ—¶é—´å·²å˜åŒ–`); 
  } 
  targetEnd=Date.now()+remaining*1000; 
  
  // V2.5: ç»Ÿä¸€ä½¿ç”¨ 4 å­—èŠ‚ä¸Šé”å‘½ä»¤ (æ›´æ–°è®¡æ—¶ï¼Œé‡æ–°å‘é€é”å®šä¿¡å·)
  const {dataView} = buildCommand(true); 
  BleManager.sendData(dataView, `çŒœæ—¶é—´æ›´æ–°å®šæ—¶ (4 å­—èŠ‚)`); 
  
  updateUI(); 
});


/* ---------- clear storage button ---------- */
$('clearStorageBtn').addEventListener('click', ()=>{
  if (confirm('ç¡®å®šæ¸…é™¤æœ¬åœ°å­˜å‚¨å¹¶é‡ç½®ç•Œé¢ï¼Ÿå°†åˆ·æ–°é¡µé¢ã€‚')){
    BleManager.disconnect(); 
    clearSavedState();
    log('ğŸ§¹ æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤ï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢ä»¥é‡ç½®çŠ¶æ€');
    setTimeout(()=>location.reload(), 200);
  }
});

/* ---------- init ---------- */
renderCalendar(); renderSelectors(); renderDateHM(); 
const had = loadState();
if (!had) {
  updateUI();
  log('ğŸŸ¢ v2.5.2 Web BLE å·²å°±ç»ª â€” è¯·ç‚¹å‡» "è¿æ¥è®¾å¤‡" æŒ‰é’®å¼€å§‹ã€‚');
} else {
  updateUI(); 
  log('ğŸ”„ æ¢å¤æœ¬åœ°å­˜å‚¨çŠ¶æ€ã€‚è¯·é‡æ–°ç‚¹å‡» "è¿æ¥è®¾å¤‡" æŒ‰é’®è¿æ¥ BLE è®¾å¤‡ã€‚');
}
</script>
</body>
</html>
